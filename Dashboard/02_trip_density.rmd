---
title: "02 Trip Density Map"
author: "Yosephine Manihuruk"
format: html
execute:
  echo: true
  warning: false
  message: false
---

```{r}
library(sf)
library(dplyr)
library(tmap)
crs_proj <- 26915

valid_trips <- readRDS("../Dashboard/data/valid_trips.rds")
road_centerlines<- readRDS("../Dashboard/data/road_centerlines.rds")
start_points <- readRDS("../Dashboard/data/start_points.rds")
```

```{r}
grid <- st_make_grid(st_union(road_centerlines), cellsize = 200) %>%
st_sf() %>% mutate(grid_id = row_number())

grid_density <- st_join(grid, start_points) %>%
st_drop_geometry() %>%
count(grid_id, name = "n") %>%
right_join(grid, by = "grid_id") %>%
mutate(n = if_else(is.na(n), 0L, n)) %>%
st_as_sf()

grid_density_nonzero <- grid_density %>% filter(n > 1)

max_cutoff <- quantile(grid_density_nonzero$n, 0.99, na.rm = TRUE)

grid_density_nonzero <- grid_density_nonzero %>%
mutate(n_trimmed = pmin(n, max_cutoff))
```

```{r}
breaks <- c(1, 20, 50, 100, 200, 400, 800, 1600, 3200, 6400)

tmap_mode("view")

tm_basemap("OpenStreetMap") +
tm_shape(grid_density_nonzero) +
tm_polygons(
col = "n_trimmed",
palette = "YlOrRd",
alpha = 0.5,
border.col = NA,
breaks = breaks,
title = "Trip Start Density"
) +
tm_layout(legend.outside = TRUE)
```

