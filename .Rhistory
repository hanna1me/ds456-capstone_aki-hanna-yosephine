library(tidyverse)
library(lubridate)
setwd("~/Desktop/dataconcat")
data_dir <- "Data/GTFS20201128"
agency <- readr::read_csv(file.path(data_dir, "agency.txt"))
routes <- readr::read_csv(file.path(data_dir, "routes.txt"))
trips  <- readr::read_csv(file.path(data_dir, "trips.txt"))
stops  <- readr::read_csv(file.path(data_dir, "stops.txt"))
calendar       <- readr::read_csv(file.path(data_dir, "calendar.txt"))
calendar_dates <- readr::read_csv(file.path(data_dir, "calendar_dates.txt"))
feed_info      <- readr::read_csv(file.path(data_dir, "feed_info.txt"))
list(
agency = dim(agency),
routes = dim(routes),
trips  = dim(trips),
stops  = dim(stops),
calendar = dim(calendar),
calendar_dates = dim(calendar_dates),
feed_info = dim(feed_info)
)
calendar <- calendar %>%
mutate(
start_date = as.Date(as.character(start_date), format = "%Y%m%d"),
end_date   = as.Date(as.character(end_date),   format = "%Y%m%d")
)
calendar_dates <- calendar_dates %>%
mutate(
exception_date = as.Date(as.character(date), format = "%Y%m%d")
) %>%
select(-date)
gtfs_trips_full <- trips %>%
left_join(routes, by = "route_id") %>%
left_join(agency, by = "agency_id") %>%
left_join(calendar, by = "service_id") %>%
left_join(calendar_dates,
by = "service_id",
multiple = "all")
if (nrow(feed_info) == 1) {
gtfs_trips_full <- gtfs_trips_full %>%
mutate(
feed_publisher_name = feed_info$feed_publisher_name[1],
feed_publisher_url  = feed_info$feed_publisher_url[1],
feed_lang           = feed_info$feed_lang[1],
default_lang        = feed_info$default_lang[1],
feed_start_date     = as.Date(
as.character(feed_info$feed_start_date[1]), "%Y%m%d"
),
feed_end_date       = as.Date(
as.character(feed_info$feed_end_date[1]), "%Y%m%d"
),
feed_version        = feed_info$feed_version[1],
feed_contact_email  = feed_info$feed_contact_email[1]
)
}
dim(gtfs_trips_full)
head(gtfs_trips_full)
gtfs_trips_clean <- gtfs_trips_full %>%
mutate(
route_type = case_when(
route_type == 0 ~ "Light Rail",
route_type == 2 ~ "Commuter Rail",
route_type == 3 ~ "Bus",
),
service_active = case_when(
is.na(exception_type) & Sys.Date() >= start_date & Sys.Date() <= end_date ~ TRUE,
exception_type == 1 & exception_date == Sys.Date() ~ TRUE,
exception_type == 2 & exception_date == Sys.Date() ~ FALSE,
TRUE ~ FALSE
)
) %>%
mutate(
route_short_name = as.character(
route_short_name
)
) %>%
mutate(
route_name = coalesce(
route_short_name, route_long_name
)
) %>%
select(
-c(route_long_name, route_short_name)
) %>%
select(
-c(wheelchair_accessible, branch_letter, agency_id, direction_id,
feed_publisher_name, feed_publisher_url, feed_lang, default_lang,
feed_start_date, feed_end_date, feed_version, feed_contact_email,
agency_timezone)
)
transit_trips_common <- gtfs_trips_full %>%
transmute(
data_source = "gtfs_metro_transit",
mode = case_when(
route_type == 0 ~ "light_rail",
route_type == 2 ~ "commuter_rail",
route_type == 3 ~ "bus",
TRUE            ~ "other_transit"
),
trip_global_id  = trip_id,
vehicle_type    = mode,
trip_duration_s = NA_real_,
trip_distance_m = NA_real_,
start_time      = as.POSIXct(NA),
end_time        = as.POSIXct(NA),
route_id,
#route_name,
trip_headsign,
direction,
service_id,
service_start_date = start_date,
service_end_date   = end_date,
exception_date,
exception_type,
agency_id,
# Placeholders
StartCenterlineID   = NA_real_,
StartCenterlineType = NA_character_,
EndCenterlineID     = NA_real_,
EndCenterlineType   = NA_character_
)
View(gtfs_trips_clean)
calendar <- calendar %>%
mutate(
start_date = as.Date(as.character(start_date), format = "%Y%m%d"),
end_date   = as.Date(as.character(end_date),   format = "%Y%m%d")
)
calendar_dates <- calendar_dates %>%
mutate(
exception_date = as.Date(as.character(date), format = "%Y%m%d")
) %>%
select(-date)
library(tidyverse)
library(dplyr)
library(sf)
library(ggplot2)
library(leaflet)
library(RColorBrewer)
all_shapes_mpls <- all_shapes_mpls %>%
mutate(
route_type_f = recode(
as.character(route_type),
`0` = "Light rail",
`2` = "Commuter rail",
`3` = "Bus",
.default = "Other"
)
)
route_levels_mpls <- sort(unique(all_shapes_mpls$route_name))
all_shapes <- shapes_routes %>%
filter(!is.na(route_id))
library(tidyverse)
library(dplyr)
library(sf)
library(ggplot2)
library(leaflet)
library(RColorBrewer)
files <- list.files("GTFS20201128", pattern = "\\.txt$", full.names = TRUE)
for (file in files) {
dat <- read_delim(file, delim = ",")
csv_name <- str_replace(file, "\\.txt$", ".csv")
write_csv(dat, csv_name)
cat("Converted:", file, "â†’", csv_name, "\n")
}
agency <- read_csv("GTFS/agency.csv")
shapes_pts <- shapes %>%
st_as_sf(coords = c("shape_pt_lon", "shape_pt_lat"),
crs = 4326, remove = FALSE)
